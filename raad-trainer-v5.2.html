<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مدرّب تحفيظ القرآن — v5.2 (نطاقات ذكية)</title>
<style>
:root{
  --bg:#f6f7fb; --fg:#111; --muted:#666; --card:#ffffff;
  --ok:#0a7a3b; --red:#b00020; --pink:#ffeaea;
  --accent:#5dade2; --accent2:#58d68d; --warn:#f5b041; --weak:#f1948a;
  --border:#e7e7e7; --shadow:0 6px 18px rgba(0,0,0,.06);
  --grad1:#e8f5e9; --grad2:#ffffff;
}
body.dark{
  --bg:#0e1512; --fg:#eef3ef; --muted:#b5c0ba; --card:#101b18;
  --border:#1e2a26; --shadow:0 6px 18px rgba(0,0,0,.25);
  --grad1:#10231d; --grad2:#0e1512;
}
html,body{height:100%}
body{
  margin:0; direction:rtl; color:var(--fg);
  background:linear-gradient(180deg,var(--grad1),var(--grad2));
  font-family:"Scheherazade","Amiri",serif;
}
header{
  position:sticky;top:0;z-index:5;background:var(--card);
  border-bottom:1px solid var(--border);padding:10px 14px;
  display:flex;align-items:center;justify-content:space-between;
}
h1{font-size:20px;margin:0}
#toggles{display:flex;gap:8px;align-items:center}
.pill{border:1px solid var(--border);background:var(--card);
  border-radius:999px;padding:6px 10px;cursor:pointer;box-shadow:var(--shadow);}
#hint{font-size:14px;color:var(--muted);padding:0 14px 8px}
main{max-width:980px;margin:0 auto;padding:12px}
#start{display:grid;place-items:center;gap:14px;margin-top:8vh}
.bigbtns{display:grid;gap:14px;width:min(560px,92%)}
.bigbtn{display:flex;align-items:center;gap:12px;justify-content:center;
  padding:18px;border-radius:16px;border:1px solid var(--border);
  background:var(--card);box-shadow:var(--shadow);font-size:1.25rem;
  cursor:pointer;transition:transform .05s ease;}
.bigbtn:active{transform:scale(.99)}
.emoji{font-size:1.4em}
#footerNote{margin-top:18px;color:var(--muted);font-size:13px}
.panel{display:none;background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:14px;box-shadow:var(--shadow)}
label{display:inline-block;margin:8px 10px 8px 0;font-size:16px}
select,input[type=number],input[type=text]{font-size:16px;padding:8px 10px;
  border:1px solid var(--border);background:var(--bg);color:var(--fg);
  border-radius:10px;min-width:110px}
.btn{font-size:1rem;padding:10px 16px;border-radius:10px;
  border:1px solid var(--border);background:var(--card);cursor:pointer}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.row + .row{margin-top:10px}
#textWrap{margin-top:12px;background:var(--card);border:1px solid var(--border);
  border-radius:12px;box-shadow:var(--shadow);padding:12px}
#text{font-size:2.0em;line-height:1.9;text-align:justify;min-height:160px;
  max-height:70vh;overflow-y:auto;padding:4px 6px}
.w{padding:2px 4px;border-radius:6px}
.shown{background:#eaf7ef22;outline:1px solid #77c49a33}
.wrongTag{color:var(--red);font-weight:bold}
.reviewedWrong{background:var(--pink);border-radius:6px}
.ctx{color:#8aa39a}
.caret{display:inline-block;width:.6em;border-bottom:2px solid var(--ok);margin:0 2px -2px 2px}
#progress{margin-top:8px;color:var(--muted)}
.bar{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(0,0,0,0),var(--bg) 35%,var(--bg));
  border-top:1px solid var(--border);padding:10px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.ctrl{font-size:1.05rem;padding:12px 18px;border-radius:12px;
  border:1px solid var(--border);background:var(--card);cursor:pointer}
#startReviewBtn,#restartBtn{display:none}
.result-box{width:fit-content;margin:16px auto;padding:16px 24px;
  border-radius:12px;font-size:1.2em;color:#fff}
.excellent{background:var(--accent2)}.verygood{background:var(--accent)}.good{background:var(--warn)}.weak{background:var(--weak)}
#savedList{display:grid;gap:8px}
.saveCard{display:flex;gap:10px;align-items:center;justify-content:space-between;
  border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--bg)}
.saveMeta{font-size:14px;color:var(--muted)}
.danger{border-color:#b0002044;color:#b00020;background:#b000200d}
a{color:#0b6aa2;text-decoration:none}
</style>
</head>
<body>
<header>
<h1>🌿 مدرّب تحفيظ القرآن — v5.2</h1>
<div id="toggles">
  <span id="soundToggle" class="pill" title="تشغيل/إيقاف الأصوات">🔈</span>
  <span id="themeToggle" class="pill" title="وضع الليل/النهار">🌙</span>
</div>
</header>
<div id="hint">⬅️ الكلمة التالية — ⬇️ تبديل الخطأ — ➡️ عودة | أثناء المراجعة: كل ضغطة ⬅️ تُكمل حتى ما قبل الخطأ التالي.</div>

<main>
<section id="start">
  <div class="bigbtns">
    <div class="bigbtn" id="btnModeRange"><span class="emoji">🕌</span><span>نطاق محدد</span></div>
    <div class="bigbtn" id="btnModeCount"><span class="emoji">🔢</span><span>بعدد الكلمات</span></div>
    <div class="bigbtn" id="btnModeSaved"><span class="emoji">🧩</span><span>محفوظاتي</span></div>
  </div>
  <div id="footerNote">نص القرآن الكريم من مشروع Tanzil (<a href="https://tanzil.net" target="_blank">tanzil.net</a>)</div>
</section>

<section id="panelRange" class="panel">
  <h3>🕌 نطاق محدد</h3>
  <div class="row">
    <label>من سورة
      <input id="fromSurahInput" list="surahList">
      <datalist id="surahList"></datalist>
      <select id="fromSurah"></select>
    </label>
    <label>آية
      <input id="fromAyahInput" type="number" min="1" style="width:80px;">
      <select id="fromAyah"></select>
    </label>
  </div>
  <div class="row">
    <label>إلى سورة
      <input id="toSurahInput" list="surahList">
      <select id="toSurah"></select>
    </label>
    <label>آية
      <input id="toAyahInput" type="number" min="1" style="width:80px;">
      <select id="toAyah"></select>
    </label>
  </div>
  <div class="row">
    <button class="btn" id="loadRangeBtn">تحميل النطاق</button>
    <button class="btn" id="backHome1">عودة</button>
  </div>
  <div id="rangeInfo" class="saveMeta" style="margin-top:6px;"></div>
</section>

<section id="panelCount" class="panel">
  <h3>🔢 توليد نطاق بعدد كلمات</h3>
  <div class="row">
    <label>بدءًا من سورة
      <input id="countSurahInput" list="surahList">
      <select id="countSurah"></select>
    </label>
    <label>آية
      <input id="countAyahInput" type="number" min="1" style="width:80px;">
      <select id="countAyah"></select>
    </label>
    <label>عدد الكلمات <input id="wordCount" type="number" min="1" value="100" style="width:100px;"></label>
  </div>
  <div class="row">
    <button class="btn" id="generateCountBtn">توليد النطاق</button>
    <button class="btn" id="backHome2">عودة</button>
  </div>
  <div id="countInfo" class="saveMeta" style="margin-top:6px;"></div>
</section>

<section id="panelSaved" class="panel">
  <h3>🧩 محفوظاتي</h3>
  <div id="savedList"></div>
  <div class="row" style="margin-top:8px">
    <button class="btn" id="backHome3">عودة</button>
  </div>
</section>

<section id="textWrap" style="display:none;">
  <div id="text"></div>
  <div id="progress"></div>
  <div class="bar">
    <button id="nextBtn" class="ctrl">➡️ الكلمة التالية</button>
    <button id="toggleWrongBtn" class="ctrl">🔁 تبديل الخطأ</button>
    <button id="backBtn" class="ctrl">⬅️ عودة</button>
    <button id="startReviewBtn" class="ctrl">🔁 ابدأ المراجعة</button>
    <button id="restartBtn" class="ctrl">🔄 إعادة المقطع</button>
    <button id="saveRangeBtn" class="ctrl">💾 حفظ</button>
  </div>
</section>
</main>

<script>
/* ========= روابط أزرار الصفحة الرئيسية ========= */
function showPanel(p){ hideAllPanels(); p.style.display='block'; }
function backHome(){ hideAllPanels(); startSec.style.display='grid'; }
function hideAllPanels(){ startSec.style.display='none'; panelRange.style.display='none'; panelCount.style.display='none'; panelSaved.style.display='none'; }

const startSec = document.getElementById('start');
const panelRange = document.getElementById('panelRange');
const panelCount = document.getElementById('panelCount');
const panelSaved = document.getElementById('panelSaved');
document.getElementById('btnModeRange').onclick=()=> showPanel(panelRange);
document.getElementById('btnModeCount').onclick=()=> showPanel(panelCount);
document.getElementById('btnModeSaved').onclick=()=> { showPanel(panelSaved); renderSavedList(); };
document.getElementById('backHome1').onclick=()=> backHome();
document.getElementById('backHome2').onclick=()=> backHome();
document.getElementById('backHome3').onclick=()=> backHome();

/* ========= الحالة العامة ========= */
let Q=null, FLAT=null;
let words=[], i=0, state="idle";
let reviewList=[], step=1, coloredErrors=[];
let ctxCount=10;
let currentRangeMeta=null; // {mode, from:{s,a}, to:{s,a}, count?}
const LS_SAVED="memorizer_saved_ranges";
const LS_SOUND="memorizer_sound_enabled";
const LS_THEME="memorizer_theme_dark";

const textWrap = document.getElementById('textWrap');
const textDiv = document.getElementById('text');
const prog = document.getElementById('progress');
const rangeInfo = document.getElementById('rangeInfo');
const countInfo = document.getElementById('countInfo');
const nextBtn = document.getElementById('nextBtn');
const toggleBtn = document.getElementById('toggleWrongBtn');
const backBtn = document.getElementById('backBtn');
const startReviewBtn = document.getElementById('startReviewBtn');
const restartBtn = document.getElementById('restartBtn');
const saveRangeBtn = document.getElementById('saveRangeBtn');
const soundToggle = document.getElementById('soundToggle');
const themeToggle = document.getElementById('themeToggle');

/* ========= أدوات عامة ========= */
function escapeHTML(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function splitWords(ar){return ar.trim().split(/\s+/).filter(Boolean);}
function linearize(Q){
  const out=[];
  for(const s of Q.surahs){
    let ayNo=1;
    for(const t of s.ayahs){
      out.push({sid:s.index, ay:ayNo, text:t, words:splitWords(t)});
      ayNo++;
    }
  }
  return out;
}
function refToFlatIndex(ref){
  for(let idx=0; idx<FLAT.length; idx++){
    if(FLAT[idx].sid===ref.s && FLAT[idx].ay===ref.a) return idx;
  }
  return -1;
}
function surahName(sid){
  const s=Q.surahs.find(x=>x.index===sid);
  return s ? s.name_ar : ("سورة "+sid);
}
function scrollToBottom(){ textDiv.scrollTop = textDiv.scrollHeight; window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); }

/* ========= الصوت (WebAudio) ========= */
let ac=null; function ensureAC(){ if(!ac) ac = new (window.AudioContext||window.webkitAudioContext)(); }
function playTone({freq=660, dur=0.15, type='sine', gain=0.06}){
  if(!soundEnabled) return;
  ensureAC(); const now = ac.currentTime;
  const o = ac.createOscillator(); const g = ac.createGain();
  o.type=type; o.frequency.setValueAtTime(freq, now);
  g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(gain, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
  o.connect(g).connect(ac.destination); o.start(now); o.stop(now+dur+.02);
}
function chime(){ playTone({freq:880, dur:0.12, type:'sine'}); setTimeout(()=>playTone({freq:1320, dur:0.12, type:'sine'}), 120); }
function pageFlip(){ playTone({freq:220, dur:0.05, type:'triangle', gain:0.04}); setTimeout(()=>playTone({freq:260, dur:0.05, type:'triangle', gain:0.035}), 60); setTimeout(()=>playTone({freq:200, dur:0.05, type:'triangle', gain:0.03}), 120); }
function woodClick(){ playTone({freq:350, dur:0.05, type:'square', gain:0.03}); }
let soundEnabled = (localStorage.getItem(LS_SOUND)!=="0");
function updateSoundIcon(){ soundToggle.textContent = soundEnabled ? "🔈" : "🔇"; }
soundToggle.onclick=()=>{ soundEnabled = !soundEnabled; localStorage.setItem(LS_SOUND, soundEnabled ? "1":"0"); updateSoundIcon(); };
updateSoundIcon();

/* ========= الوضع الليلي ========= */
let dark = (localStorage.getItem(LS_THEME)==="1");
function applyTheme(){ document.body.classList.toggle('dark', dark); themeToggle.textContent = dark ? "☀️" : "🌙"; }
applyTheme();
themeToggle.onclick=()=>{ dark=!dark; localStorage.setItem(LS_THEME, dark?"1":"0"); applyTheme(); };

/* ========= تحميل القرآن ========= */
async function ensureQ(){
  if(Q) return;
  const res = await fetch('quran.json');
  if(!res.ok){ alert('تعذّر تحميل quran.json — ضع الملف بجوار هذه الصفحة.'); throw new Error('quran.json missing'); }
  Q = await res.json();
  FLAT = linearize(Q);
  fillSurahDropdowns();
}
function fillAyahs(sSurahId, sAyahId, preselect){
  const surahId = parseInt(document.getElementById(sSurahId).value,10);
  const target = document.getElementById(sAyahId);
  target.innerHTML="";
  const s = Q.surahs.find(x=>x.index===surahId);
  for(let i=1;i<=s.ayah_count;i++){ target.add(new Option(i, i)); }
  if(preselect!=null) target.value=String(preselect);
}
function fillSurahDropdowns(){
  const fS=document.getElementById('fromSurah');
  const tS=document.getElementById('toSurah');
  const cS=document.getElementById('countSurah');
  const datalist=document.getElementById('surahList');
  datalist.innerHTML="";
  fS.innerHTML=tS.innerHTML=cS.innerHTML="";
  for(const s of Q.surahs){
    fS.add(new Option(s.name_ar,s.index));
    tS.add(new Option(s.name_ar,s.index));
    cS.add(new Option(s.name_ar,s.index));
    const dOpt=document.createElement('option'); dOpt.value=s.name_ar; datalist.appendChild(dOpt);
  }
  // ربط الإدخال النصي بالقائمة
  document.getElementById('fromSurahInput').oninput=e=>syncSurahInput(e,fS,'fromAyah',1);
  document.getElementById('toSurahInput').oninput=e=>syncSurahInput(e,tS,'toAyah');
  document.getElementById('countSurahInput').oninput=e=>syncSurahInput(e,cS,'countAyah',1);
  // تغيير القائمة يحدّث الآيات
  fS.onchange=()=>fillAyahs('fromSurah','fromAyah',1);
  tS.onchange=()=>fillAyahs('toSurah','toAyah');
  cS.onchange=()=>fillAyahs('countSurah','countAyah',1);
  // الافتراضي: الفاتحة 1 → نهاية الفاتحة
  fS.value="1"; tS.value="1"; cS.value="1";
  document.getElementById('fromSurahInput').value = Q.surahs.find(x=>x.index===1).name_ar;
  document.getElementById('toSurahInput').value   = Q.surahs.find(x=>x.index===1).name_ar;
  document.getElementById('countSurahInput').value= Q.surahs.find(x=>x.index===1).name_ar;
  fillAyahs('fromSurah','fromAyah',1);
  const first=Q.surahs.find(x=>x.index===1);
  fillAyahs('toSurah','toAyah',first.ayah_count);
  fillAyahs('countSurah','countAyah',1);
  // مزامنة رقم الآية اليدوي مع القائمة
  document.getElementById('fromAyahInput').oninput=e=>syncAyahInput(e,'fromAyah','fromSurah');
  document.getElementById('toAyahInput').oninput=e=>syncAyahInput(e,'toAyah','toSurah');
  document.getElementById('countAyahInput').oninput=e=>syncAyahInput(e,'countAyah','countSurah');
}
function syncSurahInput(e,selId,ayahSelId,ayahDefault){
  const sel = (typeof selId==="string")? document.getElementById(selId): selId;
  const val=e.target.value.trim();
  const s=Q.surahs.find(x=>x.name_ar===val);
  if(s){
    sel.value=s.index;
    sel.dispatchEvent(new Event('change'));
    if(ayahSelId){
      const aSel=document.getElementById(ayahSelId);
      if(ayahDefault!=null) aSel.value=String(ayahDefault);
    }
  }
}
function syncAyahInput(e,ayahSelId,surahSelId){
  const a = parseInt(e.target.value||"0",10);
  const sSel=document.getElementById(surahSelId);
  const s = Q.surahs.find(x=>x.index===parseInt(sSel.value,10));
  const max = s ? s.ayah_count : 0;
  const aSel=document.getElementById(ayahSelId);
  if(a>=1 && a<=max){ aSel.value=String(a); }
}

/* ========= بناء النطاقات ========= */
function makeContextTokens(startAyIndex){
  const tokens=[]; let ptr=startAyIndex-1;
  while(tokens.length<ctxCount && ptr>=0){
    const rev=FLAT[ptr].words.slice().reverse();
    for(const tok of rev){ if(tokens.length<ctxCount) tokens.push(tok); }
    ptr--;
  }
  tokens.reverse();
  return tokens.map(t=>({sid:FLAT[startAyIndex].sid, ay:FLAT[startAyIndex].ay, text:t, wrong:false, shown:true, isContext:true}));
}
function loadRangeByRefs(fromRef, toRef){
  const startAy = refToFlatIndex(fromRef);
  const endAy   = refToFlatIndex(toRef);
  if(startAy<0 || endAy<0 || endAy<startAy) { alert("نطاق غير صحيح"); return; }
  const ctx = makeContextTokens(startAy);
  const range=[];
  for(let a=startAy; a<=endAy; a++){
    for(const token of FLAT[a].words){
      range.push({sid:FLAT[a].sid, ay:FLAT[a].ay, text:token, wrong:false, shown:false, isContext:false});
    }
  }
  words = [...ctx, ...range];
  currentRangeMeta={mode:"range", from:fromRef, to:toRef};
  beginTraining();
  const sFrom = surahName(FLAT[startAy].sid);
  const sTo   = surahName(FLAT[endAy].sid);
  rangeInfo.textContent = `النطاق: ${fromRef.s}:${fromRef.a} (${sFrom}) → ${toRef.s}:${toRef.a} (${sTo}). • سياق ${ctx.length} كلمة قبل البداية.`;
}
function makeCountRange(startRef, desiredCount){
  const startAy = refToFlatIndex(startRef);
  if(startAy<0) { alert("بداية غير صحيحة"); return; }
  let collected=0; let endAy=startAy;
  for(let a=startAy; a<FLAT.length; a++){
    collected += FLAT[a].words.length;
    if(collected >= desiredCount){ endAy=a; break; }
  }
  loadRangeByRefs(startRef, {s:FLAT[endAy].sid, a:FLAT[endAy].ay});
  currentRangeMeta={mode:"count", from:startRef, count:desiredCount, to:{s:FLAT[endAy].sid, a:FLAT[endAy].ay}};
  countInfo.textContent = `توليد: من ${startRef.s}:${startRef.a} حتى ${FLAT[endAy].sid}:${FLAT[endAy].ay} (≈ ${desiredCount} كلمة؛ ينتهي بنهاية آية).`;
}

/* ========= التحفيظ والمراجعة ========= */
function renderTraining(){
  const parts=[];
  for(const w of words){
    if(w.isContext){ parts.push(`<span class="w ctx">${escapeHTML(w.text)}</span>`); }
    else if(w.shown){ parts.push(`<span class="w shown${w.wrong?' wrongTag':''}">${escapeHTML(w.text)}${w.wrong?' ❌':''}</span>`); }
    else break;
  }
  if(state==="training" && i<words.length) parts.push(`<span class="caret"></span>`);
  textDiv.innerHTML = parts.join(' ') || '<div class="ctx">ابدأ من شاشة البداية لاختيار النطاق.</div>';
  const totalLearn = words.filter(w=>!w.isContext).length;
  const seen = Math.max(0, i - words.filter(w=>w.isContext).length);
  prog.textContent = (state==="training") ? `التحفيظ — كلمة ${Math.max(0,seen)} من ${totalLearn}` : '';
  scrollToBottom();
}
function showFinalScore(){
  const all = words.filter(w=>!w.isContext);
  const correct = all.filter(w=>!w.wrong).length;
  const total = all.length;
  const percent = Math.round((correct/total)*100);
  let message="", cls="";
  if(percent>=95){ message=`🌟 نتيجتك ${percent}% — مستواك ممتاز جدًا، أحسنت!`; cls="excellent"; }
  else if(percent>=85){ message=`✅ نتيجتك ${percent}% — مستواك جيد جدًا، واصل التقدم!`; cls="verygood"; }
  else if(percent>=70){ message=`🙂 نتيجتك ${percent}% — مستواك جيد، راجع مواضع الخطأ.`; cls="good"; }
  else { message=`🔁 نتيجتك ${percent}% — تحتاج مراجعة إضافية، أعد الحفظ بإذن الله.`; cls="weak"; }
  const box=document.createElement('div'); box.className=`result-box ${cls}`; box.textContent=message;
  textDiv.appendChild(box);
  startReviewBtn.style.display="inline-block";
  prog.textContent="اضغط «ابدأ المراجعة» لتثبيت الحفظ.";
  pageFlip(); scrollToBottom();
}
function beginTraining(){
  hideAllPanels(); startSec.style.display='none'; textWrap.style.display='block';
  state="training"; i = words.findIndex(w=>!w.isContext); if(i<0) i=0;
  nextBtn.style.display="inline-block"; toggleBtn.style.display="inline-block"; backBtn.style.display="inline-block";
  startReviewBtn.style.display="none"; restartBtn.style.display="none"; renderTraining();
}
function showNext(){ if(state==="review"){ reviewAdvance(); return; } if(state!=="training") return;
  if(i<words.length){ if(words[i].isContext){ i++; showNext(); return; } words[i].shown=true; i++; renderTraining();
    if(i>=words.length){ nextBtn.style.display=toggleBtn.style.display=backBtn.style.display="none"; showFinalScore(); } } }
function toggleWrong(){ if(state!=="training") return; let idx=i-1; while(idx>=0 && words[idx].isContext) idx--; if(idx>=0){ words[idx].wrong=!words[idx].wrong; renderTraining(); } }
function goBack(){ if(state!=="training") return; if(i<=0) return; i--; while(i>0 && words[i].isContext) i--; words[i].shown=false; renderTraining(); }

function startReview(){
  reviewList=[]; for(let idx=0; idx<words.length; idx++){ if(!words[idx].isContext && words[idx].wrong) reviewList.push(idx); }
  state="review"; nextBtn.style.display="inline-block"; startReviewBtn.style.display="none"; toggleBtn.style.display="none"; backBtn.style.display="none";
  step=1; coloredErrors=[]; renderReviewStep(); woodClick();
}
function renderReviewStep(){
  const errs = reviewList; const n = step; coloredErrors = errs.slice(0, Math.max(0, n-1));
  const upTo = (n<=errs.length) ? errs[n-1] : (words.length);
  let html=""; for(let k=0;k<upTo;k++){ const w=words[k]; const cls = w.isContext ? "ctx" : (coloredErrors.includes(k) ? "reviewedWrong" : "shown"); html += `<span class="w ${cls}">${escapeHTML(w.text)}</span> `; }
  textDiv.innerHTML=html;
  if(n===errs.length+1){ for(let k=upTo;k<words.length;k++){ const w=words[k]; const cls = w.isContext ? "ctx" : (coloredErrors.includes(k) ? "reviewedWrong" : "shown"); textDiv.innerHTML += `<span class="w ${cls}">${escapeHTML(w.text)}</span> `; }
    prog.textContent=""; nextBtn.style.display="none"; restartBtn.style.display="inline-block"; textDiv.innerHTML += `<br><div class='ok'>✅ أتممت المراجعة. مواضع الخطأ مميزة باللون الوردي.</div>`; chime();
  }else{ const remain = (errs.length - n + 1); prog.textContent = `المراجعة — متبقّي ${remain} موضع`; }
  scrollToBottom();
}
function reviewAdvance(){ if(state==="review"){ step++; renderReviewStep(); } }

/* ========= حفظ النطاقات ========= */
function makeRangeName(meta){ return (meta.mode==="range") ? `من ${meta.from.s}:${meta.from.a} إلى ${meta.to.s}:${meta.to.a}` : `من ${meta.from.s}:${meta.from.a} (~${meta.count} كلمة) → ${meta.to.s}:${meta.to.a}`; }
function saveCurrentRange(){
  if(!currentRangeMeta){ alert("لا يوجد نطاق لحفظه."); return; }
  const name = prompt("اسم النطاق للحفظ:", makeRangeName(currentRangeMeta));
  if(!name) return;
  const saved = JSON.parse(localStorage.getItem(LS_SAVED) || "[]");
  saved.push({name, meta: currentRangeMeta, date: Date.now()});
  localStorage.setItem(LS_SAVED, JSON.stringify(saved));
  alert("تم حفظ النطاق في محفوظاتك.");
}
function renderSavedList(){
  const box = document.getElementById('savedList'); const saved = JSON.parse(localStorage.getItem(LS_SAVED) || "[]");
  box.innerHTML = saved.length ? "" : "<div class='saveMeta'>لا توجد نطاقات محفوظة بعد.</div>";
  saved.forEach((item, idx)=>{
    const div=document.createElement('div'); div.className='saveCard';
    const metaText = makeRangeName(item.meta);
    div.innerHTML = `<div><div><strong>${escapeHTML(item.name)}</strong></div><div class='saveMeta'>${escapeHTML(metaText)}</div></div>
    <div class='row'><button class='btn' data-idx='${idx}' data-act='load'>تحميل</button><button class='btn danger' data-idx='${idx}' data-act='del'>حذف</button></div>`;
    box.appendChild(div);
  });
  box.onclick = (e)=>{
    const t = e.target; if(t.tagName!=="BUTTON") return;
    const idx = parseInt(t.getAttribute('data-idx'),10); const act = t.getAttribute('data-act');
    const saved = JSON.parse(localStorage.getItem(LS_SAVED) || "[]"); const item = saved[idx]; if(!item) return;
    if(act==='del'){ if(confirm("حذف هذا النطاق من محفوظاتك؟")){ saved.splice(idx,1); localStorage.setItem(LS_SAVED, JSON.stringify(saved)); renderSavedList(); } }
    else if(act==='load'){ ensureQ().then(()=>{ if(item.meta.mode==="range"){ loadRangeByRefs(item.meta.from, item.meta.to); } else { makeCountRange(item.meta.from, item.meta.count); } }); }
  };
}
saveRangeBtn.onclick = saveCurrentRange;

/* ========= ربط الأزرار الأخرى ========= */
nextBtn.onclick = showNext; toggleBtn.onclick = toggleWrong; backBtn.onclick = goBack;
startReviewBtn.onclick = startReview;
/* إعادة نفس المقطع بدل العودة للصفحة */
restartBtn.onclick = ()=>{
  if(currentRangeMeta){
    ensureQ().then(()=>{
      if(currentRangeMeta.mode === "range"){
        loadRangeByRefs(currentRangeMeta.from, currentRangeMeta.to);
      } else if(currentRangeMeta.mode === "count"){
        makeCountRange(currentRangeMeta.from, currentRangeMeta.count);
      }
    });
  } else {
    location.reload();
  }
};

/* ========= تحميل/توليد النطاقات ========= */
document.getElementById('loadRangeBtn').onclick = async ()=>{
  await ensureQ();
  const from={
    s: parseInt(document.getElementById('fromSurah').value,10),
    a: parseInt(document.getElementById('fromAyah').value,10)
  };
  const to={
    s: parseInt(document.getElementById('toSurah').value,10),
    a: parseInt(document.getElementById('toAyah').value,10)
  };
  loadRangeByRefs(from,to);
};
document.getElementById('generateCountBtn').onclick = async ()=>{
  await ensureQ();
  const from={
    s: parseInt(document.getElementById('countSurah').value,10),
    a: parseInt(document.getElementById('countAyah').value,10)
  };
  const count=parseInt(document.getElementById('wordCount').value,10);
  if(!count || count<=0){ alert("أدخل عدد كلمات صحيحاً."); return; }
  makeCountRange(from,count);
};

/* ========= سلوك اللمس (داخل النص فقط) ========= */
let sx=null, sy=null;
textDiv.addEventListener('touchstart',(e)=>{ const t=e.changedTouches[0]; sx=t.clientX; sy=t.clientY; },{passive:true});
textDiv.addEventListener('touchend',(e)=>{
  const t=e.changedTouches[0]; const dx=t.clientX-(sx??t.clientX); const dy=t.clientY-(sy??t.clientY);
  const ax=Math.abs(dx), ay=Math.abs(dy); const SW=35;
  if(ax>ay && ax>SW){ if(dx<0) showNext(); else goBack(); }
  else if(ay>ax && ay>SW){ if(dy>0) toggleWrong(); }
},{passive:true});

/* ========= بدء تهيئة القوائم ========= */
ensureQ();
</script>
</body>
</html>
